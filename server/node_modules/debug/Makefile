# Get the directory of the current Makefile
THIS_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))

# Set the path for binaries
BIN_PATH := $(THIS_DIR)/node_modules/.bin
PATH     := $(BIN_PATH):$(PATH)
SHELL    := /bin/bash

# Define applications and their paths
NODE     := $(shell which node)
YARN     := $(shell which yarn)
PKG      := $(if $(YARN),$(YARN),$(NODE) $(shell which npm))
BROWSERIFY := $(NODE) $(BIN_PATH)/browserify

.PHONY: all install clean distclean

all: install test

# Install node modules
install: package.json
	@NODE_ENV=production $(PKG) install

# Lint the code
lint:
	eslint browser.js debug.js index.js node.js

# Test the code
test: node_modules coveralls
	concurrently "make test-node" "make test-browser"

# Test node
test-node:
	istanbul cover node_modules/mocha/bin/_mocha -- test/**.js

# Test browser
test-browser:
	mkdir -p dist
	$(BROWSERIFY) --standalone debug . > dist/debug.js
	karma start --single-run
	rm -rf dist

# Generate coverage report and upload to coveralls
coveralls:
	cat $(THIS_DIR)/coverage/lcov.info | $(THIS_DIR)/node_modules/coveralls/bin/coveralls.js

# Clean up
clean:
	rm -rf node_modules coverage dist

distclean: clean
	-rm -f .npm
